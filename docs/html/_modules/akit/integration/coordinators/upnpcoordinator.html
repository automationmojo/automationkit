
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>akit.integration.coordinators.upnpcoordinator &#8212; Automation Kit 1.0.0.0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for akit.integration.coordinators.upnpcoordinator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: upnpcoordinator</span>
<span class="sd">    :platform: Darwin, Linux, Unix, Windows</span>
<span class="sd">    :synopsis: Contains the UpnpCoordinator which is used for managing connectivity upnp devices visible in the automation landscape.</span>

<span class="sd">.. moduleauthor:: Myron Walker &lt;myron.walker@gmail.com&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Myron Walker&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2020, Myron W Walker&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Myron Walker&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;myron.walker@gmail.com&quot;</span>
<span class="n">__status__</span> <span class="o">=</span> <span class="s2">&quot;Development&quot;</span> <span class="c1"># Prototype, Development or Production</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;MIT&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">netifaces</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlparse</span>

<span class="kn">from</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">import</span> <span class="n">tostring</span> <span class="k">as</span> <span class="n">xml_tostring</span>
<span class="kn">from</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">import</span> <span class="n">fromstring</span> <span class="k">as</span> <span class="n">xml_fromstring</span>
<span class="kn">from</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">import</span> <span class="n">ElementTree</span><span class="p">,</span> <span class="n">Element</span><span class="p">,</span> <span class="n">SubElement</span>
<span class="kn">from</span> <span class="nn">xml.etree.ElementTree</span> <span class="kn">import</span> <span class="n">register_namespace</span>

<span class="kn">from</span> <span class="nn">akit.exceptions</span> <span class="kn">import</span> <span class="n">AKitConfigurationError</span><span class="p">,</span> <span class="n">AKitRuntimeError</span><span class="p">,</span> <span class="n">AKitCommunicationsProtocolError</span><span class="p">,</span> <span class="n">AKitSemanticError</span><span class="p">,</span> <span class="n">AKitTimeoutError</span>

<span class="kn">from</span> <span class="nn">akit.integration</span> <span class="kn">import</span> <span class="n">upnp</span> <span class="k">as</span> <span class="n">upnp_module</span>
<span class="kn">from</span> <span class="nn">akit.integration.landscaping.landscapedevice</span> <span class="kn">import</span> <span class="n">LandscapeDevice</span>

<span class="kn">from</span> <span class="nn">akit.integration.upnp.devices.upnprootdevice</span> <span class="kn">import</span> <span class="n">UpnpRootDevice</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.devices.upnprootdevice</span> <span class="kn">import</span> <span class="n">device_description_load</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.devices.upnprootdevice</span> <span class="kn">import</span> <span class="n">device_description_find_components</span>

<span class="kn">from</span> <span class="nn">akit.integration.upnp.upnperrors</span> <span class="kn">import</span> <span class="n">UpnpError</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.upnpfactory</span> <span class="kn">import</span> <span class="n">UpnpFactory</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.upnpprotocol</span> <span class="kn">import</span> <span class="n">MSearchKeys</span><span class="p">,</span> <span class="n">UpnpProtocol</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.upnpprotocol</span> <span class="kn">import</span> <span class="n">msearch_parse_request</span><span class="p">,</span> <span class="n">notify_parse_request</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.xml.upnpdevice1</span> <span class="kn">import</span> <span class="n">UPNP_DEVICE1_NAMESPACE</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.upnpprotocol</span> <span class="kn">import</span> <span class="n">mquery</span><span class="p">,</span> <span class="n">msearch_scan</span><span class="p">,</span> <span class="n">MSearchKeys</span><span class="p">,</span> <span class="n">MSearchRouteKeys</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.services.upnpeventvar</span> <span class="kn">import</span> <span class="n">UpnpEventVar</span>

<span class="kn">from</span> <span class="nn">akit.networking.interfaces</span> <span class="kn">import</span> <span class="n">get_ipv4_address</span>

<span class="kn">from</span> <span class="nn">akit.xlogging.foundations</span> <span class="kn">import</span> <span class="n">getAutomatonKitLogger</span>

<span class="n">EMPTY_LIST</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">UPNP_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">upnp_module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>

<div class="viewcode-block" id="UpnpCoordinator"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator">[docs]</a><span class="k">class</span> <span class="nc">UpnpCoordinator</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">instance</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">initialized</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Constructs new instances of the :class:`UpnpCoordinator` object. The</span>
<span class="sd">            :class:`UpnpCoordinator` object is a singleton so following instantiations</span>
<span class="sd">            of the object will reference the existing singleton</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UpnpCoordinator</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">instance</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_point</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">watch_all</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">thisType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">thisType</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
            <span class="n">thisType</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># ============================ Fixed Variables ============================</span>
            <span class="c1"># These variables are fixed at the start of the UpnpCoordinator and because</span>
            <span class="c1"># they are fixed, we don&#39;t protect them with the all.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">getAutomatonKitLogger</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_control_point</span> <span class="o">=</span> <span class="n">control_point</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_count</span> <span class="o">=</span> <span class="n">workers</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_watch_all</span> <span class="o">=</span> <span class="n">watch_all</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span> <span class="o">=</span> <span class="n">UpnpFactory</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># The count for the shutdown gate semaphore is set at startup so we don&#39;t</span>
            <span class="c1"># need to lock protect it.  Once it is set, it is fixed for the lifespan</span>
            <span class="c1"># of the UpnpCoordinator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># ======================= Coordinator Lock Variables =======================</span>
            <span class="c1"># These variables are protected and read/write synchronized by the coordinator</span>
            <span class="c1"># lock.  They are all prefixed with _cl_ so it is easy to identify in code</span>
            <span class="c1"># if the lock is being held properly when the variables are being accessed.</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>

            <span class="c1"># Callback threads are created on a per interface basis so we use a list</span>
            <span class="c1"># to manage them.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_callback_threads</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># We don&#39;t want our threads that are answering requests or filtering traffic</span>
            <span class="c1"># to do extensive amounts of work, so we have a pool of worker threads that</span>
            <span class="c1"># that work is dispatched to for incoming requests and information processing.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_worker_threads</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Collection that manages UPNP device loop by location -&gt; UpnpRootDevice</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># A lookup table from USN -&gt; devinfo for devices that were declared as</span>
            <span class="c1"># watched devices, the watched devices are devices that will be monitored</span>
            <span class="c1"># under special constraints and the coordinator will ensure they are found</span>
            <span class="c1"># during startup and will expend thread resources to ensure they are updated</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_watched_devices</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_iface_callback_addr_lookup</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># A lookup table that store device registrations for differen subscription id(s)</span>
            <span class="c1"># The UpnpCoordinator spins up one thread per interface that needs to be monitored</span>
            <span class="c1"># for callback traffic from devices and provides a callback URL for subscriptions</span>
            <span class="c1"># to the devices,  the callback threads use this table to dispatch subscription</span>
            <span class="c1"># callbacks on given interfaces to the appropriate device. So UpnpEventVar instances</span>
            <span class="c1"># can be updated.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_subscription_id_to_device</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># =========================== Queue Lock Variables ==========================</span>
            <span class="c1"># Variables that manage the work queue and dispatching of work to worker threads</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_queue_available</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_queue_work</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_match_table</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;modelName&quot;</span><span class="p">:</span> <span class="n">UpnpRootDevice</span><span class="o">.</span><span class="n">_matches_model_name</span><span class="p">,</span>
                <span class="s2">&quot;modelNumber&quot;</span><span class="p">:</span> <span class="n">UpnpRootDevice</span><span class="o">.</span><span class="n">_matches_model_number</span>
            <span class="p">}</span>

        <span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chlist</span> <span class="o">=</span> <span class="n">EMPTY_LIST</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">chlist</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">watch_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">wlist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">wd</span> <span class="k">for</span> <span class="n">wd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_watched_devices</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">wlist</span>

<div class="viewcode-block" id="UpnpCoordinator.lookup_callback_url_for_interface"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.lookup_callback_url_for_interface">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_callback_url_for_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">callback_url</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ifname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_iface_callback_addr_lookup</span><span class="p">:</span>
                <span class="n">callback_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_iface_callback_addr_lookup</span><span class="p">[</span><span class="n">ifname</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">callback_url</span></div>

<div class="viewcode-block" id="UpnpCoordinator.lookup_device_by_mac"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.lookup_device_by_mac">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_device_by_mac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mac</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Lookup a UPNP device by its MAC address.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">found</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nxtdev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">mac</span> <span class="o">==</span> <span class="n">nxtdev</span><span class="o">.</span><span class="n">MACAddress</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="n">nxtdev</span>
                    <span class="k">break</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">found</span></div>

<div class="viewcode-block" id="UpnpCoordinator.lookup_device_by_usn"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.lookup_device_by_usn">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_device_by_usn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Lookup a UPNP device by its USN id.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">found</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nxtdev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">usn</span> <span class="o">==</span> <span class="n">nxtdev</span><span class="o">.</span><span class="n">USN</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="n">nxtdev</span>
                    <span class="k">break</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">found</span></div>

<div class="viewcode-block" id="UpnpCoordinator.lookup_device_list_by_usn"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.lookup_device_list_by_usn">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_device_list_by_usn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usnlist</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">usn</span> <span class="ow">in</span> <span class="n">usnlist</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">nxtdev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">usn</span> <span class="o">==</span> <span class="n">nxtdev</span><span class="o">.</span><span class="n">USN</span><span class="p">:</span>
                        <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nxtdev</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">found</span></div>

<div class="viewcode-block" id="UpnpCoordinator.lookup_service_instance_by_sid"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.lookup_service_instance_by_sid">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_service_instance_by_sid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Lookup a service instance that had registered for subscription callbacks by sid</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">svc_inst</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_subscription_id_to_device</span><span class="p">:</span>
                <span class="n">svc_inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_subscription_id_to_device</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">svc_inst</span></div>

<div class="viewcode-block" id="UpnpCoordinator.register_subscription_for_device"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.register_subscription_for_device">[docs]</a>    <span class="k">def</span> <span class="nf">register_subscription_for_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Registers a service instance for event callbacks via a &#39;sid&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_subscription_id_to_device</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="UpnpCoordinator.startup_scan"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.startup_scan">[docs]</a>    <span class="k">def</span> <span class="nf">startup_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lscape</span><span class="p">,</span> <span class="n">upnp_hint_list</span><span class="p">,</span> <span class="n">watchlist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exclude_interfaces</span><span class="o">=</span><span class="p">[],</span> <span class="n">response_timeout</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">force_recording</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Starts up and initilizes the UPNP coordinator by utilizing a hint list to determine</span>
<span class="sd">            what network interfaces to setup UPNP monitoring on.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AKitRuntimeError</span><span class="p">(</span><span class="s2">&quot;UpnpCoordinator.startup_scan called twice, The UpnpCoordinator is already running.&quot;</span><span class="p">)</span>

        <span class="c1"># Because we only allow this method to be called once, We don&#39;t need to lock the UpnpCoordinator</span>
        <span class="c1"># for most of this activity because the only thread with a reference to use is the caller.  At</span>
        <span class="c1"># the end of this function when we startup all the callback and worker threads is when we need to</span>
        <span class="c1"># start using the lock.</span>
        <span class="k">if</span> <span class="n">upnp_hint_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">upnp_hint_list</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">hint_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">upnp_hint_list</span><span class="p">)</span>

        <span class="n">interface_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ifname</span> <span class="k">for</span> <span class="n">ifname</span> <span class="ow">in</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">interfaces</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">exif</span> <span class="ow">in</span> <span class="n">exclude_interfaces</span><span class="p">:</span>
            <span class="n">interface_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">exif</span><span class="p">)</span>

        <span class="n">config_lookup</span> <span class="o">=</span> <span class="n">lscape</span><span class="o">.</span><span class="n">_internal_get_upnp_device_config_lookup_table</span><span class="p">()</span>

        <span class="n">found_devices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">matching_devices</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">ridx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">retry</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ridx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MSEARCH: Not all devices found, retrying (count=</span><span class="si">%d</span><span class="s2">)...&quot;</span> <span class="o">%</span> <span class="n">ridx</span><span class="p">)</span>
            <span class="n">iter_found_devices</span><span class="p">,</span> <span class="n">iter_matching_devices</span> <span class="o">=</span> <span class="n">msearch_scan</span><span class="p">(</span><span class="n">upnp_hint_list</span><span class="p">,</span>
                <span class="n">interface_list</span><span class="o">=</span><span class="n">interface_list</span><span class="p">,</span> <span class="n">response_timeout</span><span class="o">=</span><span class="n">response_timeout</span><span class="p">)</span>
            <span class="n">found_devices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iter_found_devices</span><span class="p">)</span>
            <span class="n">matching_devices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iter_matching_devices</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_devices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">hint_count</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">missing_devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">expusn</span> <span class="ow">in</span> <span class="n">upnp_hint_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">expusn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matching_devices</span><span class="p">:</span>
                <span class="n">missing_devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expusn</span><span class="p">)</span>

        <span class="c1"># As a last resort, rescan for the missing devices directly on each interface.</span>
        <span class="n">query_devices</span> <span class="o">=</span> <span class="p">[</span><span class="n">mdev</span> <span class="k">for</span> <span class="n">mdev</span> <span class="ow">in</span> <span class="n">missing_devices</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">expusn</span> <span class="ow">in</span> <span class="n">query_devices</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">query_results</span> <span class="o">=</span> <span class="n">mquery</span><span class="p">(</span><span class="n">expusn</span><span class="p">,</span> <span class="n">interface_list</span><span class="o">=</span><span class="n">interface_list</span><span class="p">,</span> <span class="n">response_timeout</span><span class="o">=</span><span class="n">response_timeout</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">device_info</span> <span class="o">=</span> <span class="n">query_results</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">found_devices</span><span class="p">[</span><span class="n">expusn</span><span class="p">]</span> <span class="o">=</span> <span class="n">device_info</span>
                    <span class="n">missing_devices</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">expusn</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">AKitTimeoutError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log_scan_results</span><span class="p">(</span><span class="n">found_devices</span><span class="p">,</span> <span class="n">matching_devices</span><span class="p">,</span> <span class="n">missing_devices</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_devices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">errmsg_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Error devices missing from configuration.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MISSING DEVICES:&quot;</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">expusn</span> <span class="ow">in</span> <span class="n">missing_devices</span><span class="p">:</span>
                <span class="n">errmsg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">expusn</span><span class="p">)</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errmsg_list</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">AKitConfigurationError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dval</span> <span class="ow">in</span> <span class="n">found_devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">dval</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">IP</span><span class="p">]</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">dval</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">LOCATION</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_root_device</span><span class="p">(</span><span class="n">lscape</span><span class="p">,</span> <span class="n">config_lookup</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">dval</span><span class="p">,</span> <span class="n">force_recording</span><span class="o">=</span><span class="n">force_recording</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">watchlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">watchlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">devusn</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">USN</span>
                <span class="k">if</span> <span class="n">devusn</span> <span class="ow">in</span> <span class="n">watchlist</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cl_watched_devices</span><span class="p">[</span><span class="n">devusn</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_all_threads</span><span class="p">()</span>

        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_create_root_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manufacturer</span><span class="p">,</span> <span class="n">modelNumber</span><span class="p">,</span> <span class="n">modelDescription</span><span class="p">):</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="o">.</span><span class="n">create_root_device_instance</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">modelNumber</span><span class="p">,</span> <span class="n">modelDescription</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dev</span>

    <span class="k">def</span> <span class="nf">_log_scan_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">found_devices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">matching_devices</span><span class="p">:</span><span class="nb">dict</span> <span class="p">,</span> <span class="n">missing_devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>

        <span class="n">devmsg_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FOUND DEVICES:&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dkey</span><span class="p">,</span> <span class="n">dval</span> <span class="ow">in</span> <span class="n">found_devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dkey</span><span class="p">)</span>
        <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MATCHING DEVICES:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dkey</span><span class="p">,</span> <span class="n">dval</span> <span class="ow">in</span> <span class="n">matching_devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dkey</span><span class="p">)</span>
        <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_devices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MISSING DEVICES:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dkey</span> <span class="ow">in</span> <span class="n">missing_devices</span><span class="p">:</span>
                <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dkey</span><span class="p">)</span>
            <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">devmsg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">devmsg_lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">devmsg</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_normalize_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>

        <span class="n">normal_chars</span> <span class="o">=</span> <span class="p">[</span> <span class="n">nc</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="n">name</span> <span class="k">if</span> <span class="nb">str</span><span class="o">.</span><span class="n">isalnum</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">normal_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">normal_chars</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">normal_name</span>

    <span class="k">def</span> <span class="nf">_process_device_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usn</span><span class="p">,</span> <span class="n">request_info</span><span class="p">):</span>

        <span class="n">host</span> <span class="o">=</span> <span class="n">request_info</span><span class="p">[</span><span class="s2">&quot;HOST&quot;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">request_info</span><span class="p">[</span><span class="s2">&quot;NT&quot;</span><span class="p">]</span>
        <span class="n">subtype</span> <span class="o">=</span> <span class="n">request_info</span><span class="p">[</span><span class="s2">&quot;NTS&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">subtype</span> <span class="o">==</span> <span class="s2">&quot;ssdp:alive&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PROCESSING NOTIFY - USN: </span><span class="si">%s</span><span class="s2"> HOST: </span><span class="si">%s</span><span class="s2"> SUBTYPE: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usn</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">subtype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">subtype</span> <span class="o">==</span> <span class="s2">&quot;ssdp:byebye&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PROCESSING NOTIFY - USN: </span><span class="si">%s</span><span class="s2"> HOST: </span><span class="si">%s</span><span class="s2"> SUBTYPE: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usn</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">subtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;PROCESSING NOTIFY - USN: </span><span class="si">%s</span><span class="s2"> HOST: </span><span class="si">%s</span><span class="s2"> SUBTYPE: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">usn</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">subtype</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_process_subscription_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">claddr</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RESPONDING TO SUBSCRIPTION CALLBACK&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">req_headers</span><span class="p">,</span> <span class="n">req_body</span> <span class="o">=</span> <span class="n">notify_parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">sid</span> <span class="o">=</span> <span class="n">req_headers</span><span class="p">[</span><span class="s2">&quot;SID&quot;</span><span class="p">]</span>

        <span class="n">device</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#lookup the device that needs to handle this subscription</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_subscription_id_to_device</span><span class="p">:</span>
                <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_subscription_id_to_device</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">device</span><span class="o">.</span><span class="n">process_subscription_callback</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">req_headers</span><span class="p">,</span> <span class="n">req_body</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_process_request_for_msearch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>

        <span class="n">reqinfo</span> <span class="o">=</span> <span class="n">msearch_parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RESPONDING TO MSEARCH&quot;</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_process_request_for_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>

        <span class="n">req_headers</span><span class="p">,</span> <span class="n">req_body</span> <span class="o">=</span> <span class="n">notify_parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">usn</span> <span class="o">=</span> <span class="n">req_headers</span><span class="p">[</span><span class="s2">&quot;USN&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">usn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_watched_devices</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_device_notification</span><span class="p">(</span><span class="n">usn</span><span class="p">,</span> <span class="n">req_headers</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_start_all_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ifacelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">watch_devices</span><span class="p">:</span>
            <span class="n">primary_route</span> <span class="o">=</span> <span class="n">dev</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ifname</span> <span class="o">=</span> <span class="n">primary_route</span><span class="p">[</span><span class="n">MSearchRouteKeys</span><span class="o">.</span><span class="n">IFNAME</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ifname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ifacelist</span><span class="p">:</span>
                <span class="n">ifacelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ifname</span><span class="p">)</span>
        <span class="n">ifacecount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifacelist</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sgate</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_count</span> <span class="o">+</span> <span class="n">ifacecount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Spin-up the worker thread first so they will be ready to handle work</span>
            <span class="k">for</span> <span class="n">wkrid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_count</span><span class="p">):</span>
                <span class="n">sgate</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">wthread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;UpnpCoordinator - Worker(</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">wkrid</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_entry_worker</span><span class="p">,</span>
                                                   <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sgate</span><span class="p">,))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_worker_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wthread</span><span class="p">)</span>

                <span class="c1"># Release the coordinator lock while starting up the thread so we are not holding it</span>
                <span class="c1"># so the new thread can get access to register itself with internal UpnpCoordinator state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wthread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">sgate</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

            <span class="c1"># Spin-up the Monitor thread so it can monitor notification traffic</span>
            <span class="n">sgate</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;UpnpCoordinator - Monitor&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_entry_monitor</span><span class="p">,</span>
                                                   <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sgate</span><span class="p">,))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">sgate</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="c1"># Spin-up a Callback thread for each interface</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_iface_callback_addr_lookup</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">ifaceidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ifacecount</span><span class="p">):</span>
                <span class="n">ifname</span> <span class="o">=</span> <span class="n">ifacelist</span><span class="p">[</span><span class="n">ifaceidx</span><span class="p">]</span>
                <span class="n">sgate</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">cbthread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;UpnpCoordinator - Callback(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_entry_callback</span><span class="p">,</span>
                                                    <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sgate</span><span class="p">,</span> <span class="n">ifname</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_callback_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbthread</span><span class="p">)</span>

                <span class="c1"># Release the coordinator lock while starting up the thread so we are not holding it</span>
                <span class="c1"># so the new thread can get access to register itself with internal UpnpCoordinator state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cbthread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">sgate</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_count</span> <span class="o">+</span> <span class="n">ifacecount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_thread_entry_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sgate</span><span class="p">,</span> <span class="n">ifname</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">service_addr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

            <span class="c1"># Bind to port zero so we can get an ephimeral port address</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">service_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">get_ipv4_address</span><span class="p">(</span><span class="n">ifname</span><span class="p">)</span>

            <span class="n">iface_callback_addr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_iface_callback_addr_lookup</span><span class="p">[</span><span class="n">ifname</span><span class="p">]</span> <span class="o">=</span> <span class="n">iface_callback_addr</span>

            <span class="c1"># Set the start gate to allow the thread spinning us up to continue</span>
            <span class="n">sgate</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">cbbuffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
                <span class="n">asock</span><span class="p">,</span> <span class="n">claddr</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;CBTHREAD(</span><span class="si">%s</span><span class="s2">): Processing callback from </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="n">claddr</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
                        <span class="c1"># Process the requests</span>
                        <span class="n">nxtbuff</span> <span class="o">=</span> <span class="n">asock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nxtbuff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">cbbuffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nxtbuff</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="n">asock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

                <span class="n">request</span> <span class="o">=</span> <span class="n">cbbuffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

                <span class="n">cbbuffer</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">cbbuffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Queue the callback workpacket for dispatching by a worker thread</span>
                <span class="n">wkpacket</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_subscription_callback</span><span class="p">,</span> <span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="n">claddr</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_queue_work</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wkpacket</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_queue_available</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_thread_entry_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sgate</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="n">multicast_address</span> <span class="o">=</span> <span class="n">UpnpProtocol</span><span class="o">.</span><span class="n">MULTICAST_ADDRESS</span>
        <span class="n">multicast_port</span> <span class="o">=</span> <span class="n">UpnpProtocol</span><span class="o">.</span><span class="n">PORT</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set the start gate to allow the thread spinning us up to continue</span>
            <span class="n">sgate</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_UDP</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Make sure other Automation processes can also bind to the UPNP address and port</span>
                <span class="c1"># so they can also get responses.</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEPORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Set us up to be a member of the group, this allows us to receive all the packets</span>
                <span class="c1"># that are sent to the group</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IP_ADD_MEMBERSHIP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">multicast_address</span><span class="p">)</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">))</span>

                <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">multicast_address</span><span class="p">,</span> <span class="n">multicast_port</span><span class="p">))</span>

                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
                    <span class="n">request</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;M-SEARCH&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_control_point</span><span class="p">:</span>
                            <span class="n">wkpacket</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_request_for_msearch</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_queue_work</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wkpacket</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_queue_available</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                            <span class="k">finally</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;NOTIFY&quot;</span><span class="p">):</span>
                        <span class="n">wkpacket</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_request_for_notify</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_queue_work</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wkpacket</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_queue_available</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dbgmsg</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;UNKNOWN REQUEST TYPE:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">request</span>
                        <span class="n">dbgmsg</span> <span class="o">=</span> <span class="n">dbgmsg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dbgmsg</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_thread_entry_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sgate</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set the start gate to allow the thread spinning us up to continue</span>
            <span class="n">sgate</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_queue_available</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wkfunc</span><span class="p">,</span> <span class="n">wkargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue_work</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">wkfunc</span><span class="p">(</span><span class="o">*</span><span class="n">wkargs</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;UpnpCoordinator: Worker exception.&quot;</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_update_root_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lscape</span><span class="p">,</span> <span class="n">config_lookup</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">deviceinfo</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">force_recording</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rootdev</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">MSearchKeys</span><span class="o">.</span><span class="n">USN</span> <span class="ow">in</span> <span class="n">deviceinfo</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">usn</span> <span class="o">=</span> <span class="n">deviceinfo</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">USN</span><span class="p">]</span>
                <span class="n">devuuid</span> <span class="o">=</span> <span class="n">usn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">configinfo</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">usn</span> <span class="ow">in</span> <span class="n">config_lookup</span><span class="p">:</span>
                    <span class="n">configinfo</span> <span class="o">=</span> <span class="n">config_lookup</span><span class="p">[</span><span class="n">usn</span><span class="p">]</span>

                <span class="n">docTree</span> <span class="o">=</span> <span class="n">device_description_load</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># {urn:schemas-upnp-org:device-1-0}root</span>
                    <span class="n">namespaces</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="n">UPNP_DEVICE1_NAMESPACE</span><span class="p">}</span>

                    <span class="n">deviceDescParts</span> <span class="o">=</span> <span class="n">device_description_find_components</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">docTree</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
                    <span class="n">devNode</span><span class="p">,</span> <span class="n">urlBase</span><span class="p">,</span> <span class="n">manufacturer</span><span class="p">,</span> <span class="n">modelName</span><span class="p">,</span> <span class="n">modelNumber</span><span class="p">,</span> <span class="n">modelDescription</span> <span class="o">=</span> <span class="n">deviceDescParts</span>

                    <span class="n">dev_extension</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Acquire the lock before we decide if the location exists in the children table</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">location</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Unlock while we do some expensive stuff, we have already decided to</span>
                                <span class="c1"># create the device</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># We create the device</span>
                                    <span class="n">dev_extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_root_device</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">modelNumber</span><span class="p">,</span> <span class="n">modelDescription</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">errmsg</span> <span class="o">=</span> <span class="s2">&quot;ERROR: Unable to create device mfg=</span><span class="si">%s</span><span class="s2"> model=</span><span class="si">%s</span><span class="s2"> desc=</span><span class="si">%s</span><span class="se">\n</span><span class="s2">TRACEBACK:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">modelNumber</span><span class="p">,</span> <span class="n">modelDescription</span><span class="p">)</span>
                                    <span class="n">errmsg</span> <span class="o">+=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
                                    <span class="k">raise</span>

                                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dev_extension</span><span class="p">)</span> <span class="o">==</span> <span class="n">UpnpRootDevice</span><span class="p">:</span>
                                    <span class="n">dev_extension</span><span class="o">.</span><span class="n">record_description</span><span class="p">(</span><span class="n">urlBase</span><span class="p">,</span> <span class="n">manufacturer</span><span class="p">,</span> <span class="n">modelName</span><span class="p">,</span> <span class="n">docTree</span><span class="p">,</span> <span class="n">devNode</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">,</span> <span class="n">force_recording</span><span class="o">=</span><span class="n">force_recording</span><span class="p">)</span>

                                <span class="n">coord_ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

                                <span class="n">basedevice</span> <span class="o">=</span> <span class="n">LandscapeDevice</span><span class="p">(</span><span class="n">usn</span><span class="p">,</span> <span class="s2">&quot;network/upnp&quot;</span><span class="p">,</span> <span class="n">deviceinfo</span><span class="p">)</span>
                                <span class="n">basedevice</span><span class="o">.</span><span class="n">update_match_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_match_table</span><span class="p">)</span>

                                <span class="n">basedevice_ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">basedevice</span><span class="p">)</span>

                                <span class="n">dev_extension</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">coord_ref</span><span class="p">,</span> <span class="n">basedevice_ref</span><span class="p">,</span> <span class="n">usn</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">configinfo</span><span class="p">,</span> <span class="n">deviceinfo</span><span class="p">)</span>

                                <span class="c1"># Refresh the description</span>
                                <span class="n">dev_extension</span><span class="o">.</span><span class="n">refresh_description</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">,</span> <span class="n">docTree</span><span class="o">.</span><span class="n">getroot</span><span class="p">(),</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>

                                <span class="n">basedevice</span><span class="o">.</span><span class="n">attach_extension</span><span class="p">(</span><span class="s2">&quot;upnp&quot;</span><span class="p">,</span> <span class="n">dev_extension</span><span class="p">)</span>

                                <span class="n">lscape</span><span class="o">.</span><span class="n">_internal_register_device</span><span class="p">(</span><span class="n">usn</span><span class="p">,</span> <span class="n">basedevice</span><span class="p">)</span>
                            <span class="k">finally</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                            <span class="c1"># If the device is still not in the table, add it</span>
                            <span class="k">if</span> <span class="n">location</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_extension</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dev_extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="p">[</span><span class="n">location</span><span class="p">]</span>
                            <span class="c1"># Refresh the description</span>
                            <span class="n">dev_extension</span><span class="o">.</span><span class="n">refresh_description</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">,</span> <span class="n">docTree</span><span class="o">.</span><span class="n">getroot</span><span class="p">(),</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">errmsg_lines</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;ERROR: Unable to parse description for. IP: </span><span class="si">%s</span><span class="s2"> LOCATION: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">deviceinfo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">errmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

                    <span class="n">errmsg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errmsg_lines</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">errmsg_lines</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;ERROR: Unable to parse description for. IP: </span><span class="si">%s</span><span class="s2"> LOCATION: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">deviceinfo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">errmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

                <span class="n">errmsg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errmsg_lines</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

        <span class="k">return</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="kn">import</span> <span class="nn">akit.environment.activate</span> <span class="c1"># pylint: disable=unused-import</span>

    <span class="kn">from</span> <span class="nn">akit.xlogging.foundations</span> <span class="kn">import</span> <span class="n">logging_initialize</span>
    <span class="n">logging_initialize</span><span class="p">()</span>

    <span class="kn">from</span> <span class="nn">akit.integration.landscaping.landscape</span> <span class="kn">import</span> <span class="n">Landscape</span>


    <span class="n">lscape</span> <span class="o">=</span> <span class="n">Landscape</span><span class="p">()</span>
    <span class="n">lscape</span><span class="o">.</span><span class="n">first_contact</span><span class="p">()</span>

    <span class="n">s17</span> <span class="o">=</span> <span class="n">lscape</span><span class="o">.</span><span class="n">lookup_device_by_modelNumber</span><span class="p">(</span><span class="s2">&quot;S17&quot;</span><span class="p">)</span>

    <span class="c1">#muse_coord = lscape.muse_coord</span>
    <span class="c1">#firstMuseAgent = muse_coord.device_agents[0]</span>

    <span class="c1">#firstMuseAgent.households()</span>

    <span class="n">upnpcoord</span> <span class="o">=</span> <span class="n">lscape</span><span class="o">.</span><span class="n">upnp_coord</span>
    <span class="n">firstdev</span> <span class="o">=</span> <span class="n">upnpcoord</span><span class="o">.</span><span class="n">watch_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">firstdev</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">firstdev</span><span class="p">)</span>

    <span class="n">devProps</span> <span class="o">=</span> <span class="n">firstdev</span><span class="o">.</span><span class="n">serviceDeviceProperties</span><span class="p">()</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">devProps</span><span class="o">.</span><span class="n">action_GetLEDState</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">devProps</span><span class="o">.</span><span class="n">subscribe_to_events</span><span class="p">():</span>
        <span class="n">var_mic_enabled</span> <span class="o">=</span> <span class="n">devProps</span><span class="o">.</span><span class="n">lookup_event_variable</span><span class="p">(</span><span class="s2">&quot;MicEnabled&quot;</span><span class="p">)</span>
        <span class="n">meval</span> <span class="o">=</span> <span class="n">var_mic_enabled</span><span class="o">.</span><span class="n">wait_for_value</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">var_mic_enabled</span><span class="p">)</span>

        <span class="n">var_zonename</span> <span class="o">=</span> <span class="n">devProps</span><span class="o">.</span><span class="n">lookup_event_variable</span><span class="p">(</span><span class="s2">&quot;ZoneName&quot;</span><span class="p">)</span>
        <span class="n">znval</span> <span class="o">=</span> <span class="n">var_zonename</span><span class="o">.</span><span class="n">wait_for_value</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">var_zonename</span><span class="p">)</span>

        <span class="n">isbval</span> <span class="o">=</span> <span class="n">devProps</span><span class="o">.</span><span class="n">lookup_event_variable</span><span class="p">(</span><span class="s2">&quot;IsZoneBridge&quot;</span><span class="p">)</span>
        <span class="nb">print</span> <span class="p">(</span><span class="n">isbval</span><span class="p">)</span>

    <span class="n">LEDSTATES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Off&quot;</span><span class="p">,</span> <span class="s2">&quot;On&quot;</span><span class="p">]</span>

    <span class="n">small_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">large_counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">small_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tick&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tock&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">large_counter</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Refreshing upnp device status.&quot;</span><span class="p">)</span>

        <span class="n">small_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">small_counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="n">large_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">large_counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">30</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">Automation Kit</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../_apidoc/modules.html">akit</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Myron W. Walker.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>