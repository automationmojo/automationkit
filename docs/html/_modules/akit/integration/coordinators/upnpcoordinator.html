<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>akit.integration.coordinators.upnpcoordinator &mdash; Automation Kit 0.2 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> Automation Kit
          </a>
              <div class="version">
                0.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Table of Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../_usermanual/usermanual.html">User Manual</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../_apidoc/modules.html">akit</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Automation Kit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>akit.integration.coordinators.upnpcoordinator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for akit.integration.coordinators.upnpcoordinator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: upnpcoordinator</span>
<span class="sd">    :platform: Darwin, Linux, Unix, Windows</span>
<span class="sd">    :synopsis: Contains the UpnpCoordinator which is used for managing connectivity upnp devices visible in the automation landscape.</span>

<span class="sd">.. moduleauthor:: Myron Walker &lt;myron.walker@gmail.com&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Myron Walker&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;Copyright 2020, Myron W Walker&quot;</span>
<span class="n">__credits__</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s2">&quot;Myron Walker&quot;</span>
<span class="n">__email__</span> <span class="o">=</span> <span class="s2">&quot;myron.walker@gmail.com&quot;</span>
<span class="n">__status__</span> <span class="o">=</span> <span class="s2">&quot;Development&quot;</span> <span class="c1"># Prototype, Development or Production</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s2">&quot;MIT&quot;</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span><span class="p">,</span> <span class="n">SEEK_END</span>

<span class="kn">import</span> <span class="nn">netifaces</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">from</span> <span class="nn">akit.environment.variables</span> <span class="kn">import</span> <span class="n">AKIT_VARIABLES</span>
<span class="kn">from</span> <span class="nn">akit.exceptions</span> <span class="kn">import</span> <span class="n">AKitConfigurationError</span><span class="p">,</span> <span class="n">AKitRuntimeError</span><span class="p">,</span> <span class="n">AKitTimeoutError</span>

<span class="kn">from</span> <span class="nn">akit.networking.constants</span> <span class="kn">import</span> <span class="n">AKitHttpHeaders</span><span class="p">,</span> <span class="n">HTTP1_1_LINESEP</span><span class="p">,</span> <span class="n">HTTP1_1_END_OF_HEADER</span>
<span class="kn">from</span> <span class="nn">akit.networking.interfaces</span> <span class="kn">import</span> <span class="n">get_interface_for_ip</span>
<span class="kn">from</span> <span class="nn">akit.networking.resolution</span> <span class="kn">import</span> <span class="n">get_arp_table</span><span class="p">,</span> <span class="n">refresh_arp_table</span>

<span class="kn">from</span> <span class="nn">akit.integration</span> <span class="kn">import</span> <span class="n">upnp</span> <span class="k">as</span> <span class="n">upnp_module</span>
<span class="kn">from</span> <span class="nn">akit.integration.landscaping.landscapedevice</span> <span class="kn">import</span> <span class="n">LandscapeDevice</span>

<span class="kn">from</span> <span class="nn">akit.integration.upnp.devices.upnprootdevice</span> <span class="kn">import</span> <span class="n">UpnpRootDevice</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.devices.upnprootdevice</span> <span class="kn">import</span> <span class="n">device_description_load</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.devices.upnprootdevice</span> <span class="kn">import</span> <span class="n">device_description_find_components</span>

<span class="kn">from</span> <span class="nn">akit.integration.upnp.upnpfactory</span> <span class="kn">import</span> <span class="n">UpnpFactory</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.upnpprotocol</span> <span class="kn">import</span> <span class="n">mquery_host</span><span class="p">,</span> <span class="n">msearch_scan</span><span class="p">,</span> <span class="n">notify_parse_request</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.upnpprotocol</span> <span class="kn">import</span> <span class="n">MSearchKeys</span><span class="p">,</span> <span class="n">MSearchRouteKeys</span><span class="p">,</span> <span class="n">UpnpProtocol</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.services.upnpserviceproxy</span> <span class="kn">import</span> <span class="n">UpnpServiceProxy</span>
<span class="kn">from</span> <span class="nn">akit.integration.upnp.xml.upnpdevice1</span> <span class="kn">import</span> <span class="n">UPNP_DEVICE1_NAMESPACE</span>

<span class="kn">from</span> <span class="nn">akit.integration.coordinators.coordinatorbase</span> <span class="kn">import</span> <span class="n">CoordinatorBase</span>

<span class="kn">from</span> <span class="nn">akit.networking.interfaces</span> <span class="kn">import</span> <span class="n">get_ipv4_address</span>

<span class="kn">from</span> <span class="nn">akit.paths</span> <span class="kn">import</span> <span class="n">get_path_for_output</span>

<span class="c1"># Types imported only for type checking purposes</span>
<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">akit.integration.landscaping.landscape</span> <span class="kn">import</span> <span class="n">Landscape</span>

<span class="n">EMPTY_LIST</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">UPNP_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">upnp_module</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>

<span class="n">UPNP_SUBSCRIPTION_NOTIFY_RESPONSE_OK</span> <span class="o">=</span> <span class="n">HTTP1_1_LINESEP</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
    <span class="sa">b</span><span class="s1">&#39;HTTP/1.1 200 OK&#39;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s1">&#39;Connection: close&#39;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s1">&#39;Content-Length: 0&#39;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s1">&#39;Content-Type: text/html&#39;</span><span class="p">,</span>
    <span class="sa">b</span><span class="s1">&#39;Server: </span><span class="si">%s</span><span class="s1">,UPnP/1.0&#39;</span> <span class="o">%</span> <span class="n">AKitHttpHeaders</span><span class="o">.</span><span class="n">SERVER</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
    <span class="sa">b</span><span class="s1">&#39;&#39;</span>
<span class="p">])</span>

<div class="viewcode-block" id="http_parse_header"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.http_parse_header">[docs]</a><span class="k">def</span> <span class="nf">http_parse_header</span><span class="p">(</span><span class="n">header_content</span><span class="p">):</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">header_lines</span> <span class="o">=</span> <span class="n">header_content</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;The header content was not a valid HTTP request header.&quot;</span>
    <span class="n">req_line</span> <span class="o">=</span> <span class="n">header_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">hline</span> <span class="ow">in</span> <span class="n">header_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">name_end</span> <span class="o">=</span> <span class="n">hline</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name_end</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">hname</span> <span class="o">=</span> <span class="n">hline</span><span class="p">[:</span><span class="n">name_end</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">hval</span> <span class="o">=</span> <span class="n">hline</span><span class="p">[</span><span class="n">name_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">headers</span><span class="p">[</span><span class="n">hname</span><span class="p">]</span> <span class="o">=</span> <span class="n">hval</span>
    <span class="k">return</span> <span class="n">req_line</span><span class="p">,</span> <span class="n">headers</span></div>

<div class="viewcode-block" id="UpnpCoordinator"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator">[docs]</a><span class="k">class</span> <span class="nc">UpnpCoordinator</span><span class="p">(</span><span class="n">CoordinatorBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The UpnpCoordinator utilizes the expected device declarations of type &#39;network/upnp&#39; to establish and maintain connectivity</span>
<span class="sd">        and interoperability with UPNP based network devices.  The UpnpCoordinator will scan all interfaces except for the excluded</span>
<span class="sd">        interfaces.  It also creates a general broadcast monitor thread and a subscription dispatch thread for each interface it</span>
<span class="sd">        is monitoring.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># pylint: disable=attribute-defined-outside-init</span>

    <span class="n">UPNP_CACHE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AKIT_VARIABLES</span><span class="o">.</span><span class="n">AKIT_CONFIG_DIRECTORY</span><span class="p">,</span> <span class="s2">&quot;cache&quot;</span><span class="p">,</span> <span class="s2">&quot;upnp&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lscape</span><span class="p">:</span> <span class="s2">&quot;Landscape&quot;</span><span class="p">,</span> <span class="n">control_point</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UpnpCoordinator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">lscape</span><span class="p">,</span> <span class="n">control_point</span><span class="o">=</span><span class="n">control_point</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">_args</span><span class="p">,</span> <span class="n">control_point</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Called by the CoordinatorBase constructor to perform the one time initialization of the coordinator Singleton</span>
<span class="sd">            of a given type.</span>

<span class="sd">            :param control_point: An object that acts as a UPNP control point.</span>
<span class="sd">            :param workers: The number of worker threads to spin up for handling work packets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=arguments-differ</span>

        <span class="c1"># ============================ Fixed Variables ============================</span>
        <span class="c1"># These variables are fixed at the start of the UpnpCoordinator and because</span>
        <span class="c1"># they are fixed, we don&#39;t protect them with the all.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_control_point</span> <span class="o">=</span> <span class="n">control_point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_count</span> <span class="o">=</span> <span class="n">workers</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span> <span class="o">=</span> <span class="n">UpnpFactory</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_unknown_devices</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_upnp_recording</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># The count for the shutdown gate semaphore is set at startup so we don&#39;t</span>
        <span class="c1"># need to lock protect it.  Once it is set, it is fixed for the lifespan</span>
        <span class="c1"># of the UpnpCoordinator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># ======================= Coordinator Lock Variables =======================</span>
        <span class="c1"># These variables are protected and read/write synchronized by the coordinator</span>
        <span class="c1"># lock.  They are all prefixed with _cl_ so it is easy to identify in code</span>
        <span class="c1"># if the lock is being held properly when the variables are being accessed.</span>

        <span class="c1"># Callback threads are created on a per interface basis so we use a list</span>
        <span class="c1"># to manage them.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_callback_threads</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># We don&#39;t want our threads that are answering requests or filtering traffic</span>
        <span class="c1"># to do extensive amounts of work, so we have a pool of worker threads that</span>
        <span class="c1"># that work is dispatched to for incoming requests and information processing.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_worker_threads</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># A lookup table from USN -&gt; devinfo for devices that were declared as</span>
        <span class="c1"># watched devices, the watched devices are devices that will be monitored</span>
        <span class="c1"># under special constraints and the coordinator will ensure they are found</span>
        <span class="c1"># during startup and will expend thread resources to ensure they are updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_watched_devices</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_iface_callback_addr_lookup</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># A lookup table that store device registrations for differen subscription id(s)</span>
        <span class="c1"># The UpnpCoordinator spins up one thread per interface that needs to be monitored</span>
        <span class="c1"># for callback traffic from devices and provides a callback URL for subscriptions</span>
        <span class="c1"># to the devices,  the callback threads use this table to dispatch subscription</span>
        <span class="c1"># callbacks on given interfaces to the appropriate device. So UpnpEventVar instances</span>
        <span class="c1"># can be updated.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_subscription_id_to_device</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># =========================== Queue Lock Variables ==========================</span>
        <span class="c1"># Variables that manage the work queue and dispatching of work to worker threads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue_available</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue_work</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_match_table</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;modelName&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;upnp&#39;</span><span class="p">,</span> <span class="n">UpnpRootDevice</span><span class="o">.</span><span class="n">_matches_model_name</span><span class="p">),</span> <span class="c1"># pylint: disable=protected-access</span>
            <span class="s2">&quot;modelNumber&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;upnp&#39;</span><span class="p">,</span> <span class="n">UpnpRootDevice</span><span class="o">.</span><span class="n">_matches_model_number</span><span class="p">)</span> <span class="c1"># pylint: disable=protected-access</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_excluded_interfaces</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;lo&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_cl_callback_interface_sockets</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">watch_devices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">LandscapeDevice</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Returns a list of the devices being watched by the UPNP coordinator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wlist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">wd</span> <span class="k">for</span> <span class="n">wd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_watched_devices</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">wlist</span>

<div class="viewcode-block" id="UpnpCoordinator.establish_presence"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.establish_presence">[docs]</a>    <span class="k">def</span> <span class="nf">establish_presence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">watched_devices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">watch_devices</span>

        <span class="k">for</span> <span class="n">wdev</span> <span class="ow">in</span> <span class="n">watched_devices</span><span class="p">:</span>
            <span class="n">wdev</span><span class="o">.</span><span class="n">upnp</span><span class="o">.</span><span class="n">set_auto_subscribe</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="UpnpCoordinator.lookup_callback_url_for_interface"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.lookup_callback_url_for_interface">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_callback_url_for_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifname</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The callback url that is utilized by devices to determine the URL that should be used as a callback</span>
<span class="sd">            for a given network interface.</span>

<span class="sd">            :param ifname: The interface name of the interface to get the callback url for.</span>

<span class="sd">            :returns: Returns the callback url being monintored by the coordinator for a given interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">callback_url</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ifname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_iface_callback_addr_lookup</span><span class="p">:</span>
                <span class="n">callback_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_iface_callback_addr_lookup</span><span class="p">[</span><span class="n">ifname</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">callback_url</span></div>

<div class="viewcode-block" id="UpnpCoordinator.lookup_device_by_mac"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.lookup_device_by_mac">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_device_by_mac</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mac</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">LandscapeDevice</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Lookup a UPNP device by its MAC address.</span>

<span class="sd">            :param mac: The mac address of the device to search for.</span>

<span class="sd">            :returns: The device found with the associated MAC address or None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">found</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nxtdev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">mac</span> <span class="o">==</span> <span class="n">nxtdev</span><span class="o">.</span><span class="n">MACAddress</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="n">nxtdev</span><span class="o">.</span><span class="n">basedevice</span>
                    <span class="k">break</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">found</span></div>

<div class="viewcode-block" id="UpnpCoordinator.lookup_device_by_usn"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.lookup_device_by_usn">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_device_by_usn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">LandscapeDevice</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Lookup a UPNP device by its USN id.</span>

<span class="sd">            :param usn: The usn of the device to search for.</span>

<span class="sd">            :returns: The device found with the associated USN address or None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">found</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">nxtdev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">nxtdev</span><span class="o">.</span><span class="n">USN</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">usn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">found</span> <span class="o">=</span> <span class="n">nxtdev</span><span class="o">.</span><span class="n">basedevice</span>
                    <span class="k">break</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">found</span></div>

<div class="viewcode-block" id="UpnpCoordinator.lookup_device_list_by_usn"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.lookup_device_list_by_usn">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_device_list_by_usn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usnlist</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">LandscapeDevice</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Lookup a list of UPNP devices by thier USN id.</span>

<span class="sd">            :param usn: A list of USN identifiers for devices to search for.</span>

<span class="sd">            :returns: A list of devices found with USN(s) in the usn search list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">usn</span> <span class="ow">in</span> <span class="n">usnlist</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">nxtdev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">usn</span> <span class="o">==</span> <span class="n">nxtdev</span><span class="o">.</span><span class="n">USN</span><span class="p">:</span>
                        <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nxtdev</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">found</span></div>

<div class="viewcode-block" id="UpnpCoordinator.lookup_device_instance_for_sid"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.lookup_device_instance_for_sid">[docs]</a>    <span class="k">def</span> <span class="nf">lookup_device_instance_for_sid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UpnpServiceProxy</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Lookup a device instance that has been registered with a subscription id.</span>

<span class="sd">            :param sid: The sid of a service device to search for.</span>

<span class="sd">            :returns: A device found to be associated with the sid provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">device_inst</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_subscription_id_to_device</span><span class="p">:</span>
                <span class="n">device_inst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_subscription_id_to_device</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">device_inst</span></div>

<div class="viewcode-block" id="UpnpCoordinator.register_subscription_for_device"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.register_subscription_for_device">[docs]</a>    <span class="k">def</span> <span class="nf">register_subscription_for_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">device</span><span class="p">:</span> <span class="n">LandscapeDevice</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Registers a service instance for event callbacks via a &#39;sid&#39;.</span>

<span class="sd">            :param sid: The service subscription id to register a device with.</span>
<span class="sd">            :param device: The device to register as a handler for notifications for the sid provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_subscription_id_to_device</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="UpnpCoordinator.startup_scan"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.startup_scan">[docs]</a>    <span class="k">def</span> <span class="nf">startup_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_devices</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">],</span> <span class="n">required_devices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">watchlist</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">exclude_interfaces</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">response_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">retry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">upnp_recording</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">allow_unknown_devices</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Starts up and initilizes the UPNP coordinator by utilizing a hint list to determine</span>
<span class="sd">            what network interfaces to setup UPNP monitoring on.</span>

<span class="sd">            :param query_devices: A list of upnp USN(s) to search for.</span>
<span class="sd">            :param required_devices: A list of required USN(s) that we will setup watching and updates for.</span>
<span class="sd">            :param exclude_interfaces: Network interfaces that will be excluded from the search for devices.</span>
<span class="sd">            :param response_timeout: A timeout to wait for a response.</span>
<span class="sd">            :param retry: The number of retry attempts to make before giving up on finding devices.</span>
<span class="sd">            :param upnp_recording: Forces the updating or recording of device descriptions from devices found on the network.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=dangerous-default-value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_allow_unknown_devices</span> <span class="o">=</span> <span class="n">allow_unknown_devices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_upnp_recording</span> <span class="o">=</span> <span class="n">upnp_recording</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_excluded_interfaces</span> <span class="o">=</span> <span class="n">exclude_interfaces</span>

        <span class="n">lscape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">landscape</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AKitRuntimeError</span><span class="p">(</span><span class="s2">&quot;UpnpCoordinator.startup_scan called twice, The UpnpCoordinator is already running.&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

        <span class="c1"># Because we only allow this method to be called once, We don&#39;t need to lock the UpnpCoordinator</span>
        <span class="c1"># for most of this activity because the only thread with a reference to use is the caller.  At</span>
        <span class="c1"># the end of this function when we startup all the callback and worker threads is when we need to</span>
        <span class="c1"># start using the lock.</span>
        <span class="k">if</span> <span class="n">query_devices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">query_devices</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">interface_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">ifname</span> <span class="k">for</span> <span class="n">ifname</span> <span class="ow">in</span> <span class="n">netifaces</span><span class="o">.</span><span class="n">interfaces</span><span class="p">()]</span>
        <span class="k">for</span> <span class="n">exif</span> <span class="ow">in</span> <span class="n">exclude_interfaces</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exif</span> <span class="ow">in</span> <span class="n">interface_list</span><span class="p">:</span>
                <span class="n">interface_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">exif</span><span class="p">)</span>

        <span class="n">found_devices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">matching_devices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">missing_devices</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">remaining_query_devices</span> <span class="o">=</span> <span class="p">[</span> <span class="n">usn</span> <span class="k">for</span> <span class="n">usn</span> <span class="ow">in</span> <span class="n">query_devices</span><span class="p">]</span>

        <span class="c1"># When we look in the cache, the found devices are also the matching devices</span>
        <span class="n">cache_found</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_cache_scan</span><span class="p">(</span><span class="n">remaining_query_devices</span><span class="p">)</span>
        <span class="n">found_devices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cache_found</span><span class="p">)</span>
        <span class="n">matching_devices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cache_found</span><span class="p">)</span>

        <span class="c1"># Remove the devices that we found from the list of device to query for</span>
        <span class="k">for</span> <span class="n">fdev_usn</span> <span class="ow">in</span> <span class="n">cache_found</span><span class="p">:</span>
            <span class="n">remaining_query_devices</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fdev_usn</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_query_devices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msearch_found</span><span class="p">,</span> <span class="n">msearch_matching</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_msearch_scan</span><span class="p">(</span>
                <span class="n">remaining_query_devices</span><span class="p">,</span> <span class="n">interface_list</span><span class="o">=</span><span class="n">interface_list</span><span class="p">,</span>
                <span class="n">response_timeout</span><span class="o">=</span><span class="n">response_timeout</span><span class="p">,</span> <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span>

            <span class="n">found_devices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">msearch_found</span><span class="p">)</span>
            <span class="n">matching_devices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">msearch_matching</span><span class="p">)</span>

            <span class="c1"># Remove the devices that we found from the list of device to query for</span>
            <span class="k">for</span> <span class="n">fdev_usn</span> <span class="ow">in</span> <span class="n">msearch_found</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fdev_usn</span> <span class="ow">in</span> <span class="n">remaining_query_devices</span><span class="p">:</span>
                    <span class="n">remaining_query_devices</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fdev_usn</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_query_devices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">final_found</span><span class="p">,</span> <span class="n">final_matching</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_scan_with_arp_and_mquery</span><span class="p">(</span><span class="n">remaining_query_devices</span><span class="p">,</span>
                <span class="n">interface_list</span><span class="o">=</span><span class="n">interface_list</span><span class="p">,</span> <span class="n">response_timeout</span><span class="o">=</span><span class="n">response_timeout</span><span class="p">,</span>
                <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="p">)</span>

        <span class="n">missing_devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">required_devices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">expusn</span> <span class="ow">in</span> <span class="n">required_devices</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">expusn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">matching_devices</span><span class="p">:</span>
                    <span class="n">missing_devices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expusn</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_devices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">errmsg_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Error devices missing from configuration.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;MISSING DEVICES:&quot;</span>
            <span class="p">]</span>
            <span class="k">for</span> <span class="n">expusn</span> <span class="ow">in</span> <span class="n">missing_devices</span><span class="p">:</span>
                <span class="n">errmsg_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">expusn</span><span class="p">)</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errmsg_list</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">AKitConfigurationError</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

        <span class="n">config_lookup</span> <span class="o">=</span> <span class="n">lscape</span><span class="o">.</span><span class="n">_internal_get_upnp_device_config_lookup_table</span><span class="p">()</span> <span class="c1"># pylint: disable=protected-access</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dval</span> <span class="ow">in</span> <span class="n">matching_devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">addr</span> <span class="o">=</span> <span class="n">dval</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">IP</span><span class="p">]</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">dval</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">LOCATION</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_root_device</span><span class="p">(</span><span class="n">lscape</span><span class="p">,</span> <span class="n">config_lookup</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">dval</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">watchlist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">watchlist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">wdev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">dev_id</span> <span class="o">=</span> <span class="n">wdev</span><span class="o">.</span><span class="n">upnp</span><span class="o">.</span><span class="n">USN_DEV</span>
                <span class="k">if</span> <span class="n">dev_id</span> <span class="ow">in</span> <span class="n">watchlist</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_cl_watched_devices</span><span class="p">[</span><span class="n">dev_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">wdev</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_log_scan_results</span><span class="p">(</span><span class="n">found_devices</span><span class="p">,</span> <span class="n">matching_devices</span><span class="p">,</span> <span class="n">missing_devices</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_device_cache_update</span><span class="p">(</span><span class="n">found_devices</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_start_all_threads</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_found_devices</span> <span class="o">=</span> <span class="n">found_devices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_found_devices</span> <span class="o">=</span> <span class="n">found_devices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_available_devices</span> <span class="o">=</span> <span class="n">matching_devices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unavailable_devices</span> <span class="o">=</span> <span class="n">missing_devices</span>

        <span class="k">return</span> <span class="n">found_devices</span><span class="p">,</span> <span class="n">matching_devices</span><span class="p">,</span> <span class="n">missing_devices</span></div>

<div class="viewcode-block" id="UpnpCoordinator.wakeup_device"><a class="viewcode-back" href="../../../../_apidoc/akit.integration.coordinators.html#akit.integration.coordinators.upnpcoordinator.UpnpCoordinator.wakeup_device">[docs]</a>    <span class="k">def</span> <span class="nf">wakeup_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usn</span><span class="p">,</span> <span class="n">dev_hint</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;TODO: Implement an overload for UpnpCoordinatorIntegration:wakeup_device.&quot;</span><span class="p">)</span>
        <span class="k">return</span></div>

    <span class="k">def</span> <span class="nf">_create_root_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manufacturer</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_number</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">model_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UpnpRootDevice</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create a root UPNP device using the provided manufacturer and modelNumber provided.  If no</span>
<span class="sd">            device is found for the provided manufacturer and model_number then a generic UPNP root device</span>
<span class="sd">            will be instantiated using the manufacturer, model_number and model_description.</span>

<span class="sd">            :param manufacturer: The manufacturer of the root device to instantiate.</span>
<span class="sd">            :param model_number: The model_number of the root device to instantiate.</span>
<span class="sd">            :param model_description: The description to give to a device when it is instantiated.</span>

<span class="sd">            :returns: A upnp root device instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="o">.</span><span class="n">create_root_device_instance</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">model_number</span><span class="p">,</span> <span class="n">model_description</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dev</span>

    <span class="k">def</span> <span class="nf">_device_cache_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>

        <span class="n">found_devices</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">qdev_usn</span> <span class="ow">in</span> <span class="n">query_devices</span><span class="p">:</span>
            <span class="n">qdev_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPNP_CACHE_DIR</span><span class="p">,</span> <span class="n">qdev_usn</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">qdev_filename</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">qdev_filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">qdf</span><span class="p">:</span>
                    <span class="n">dicontent</span> <span class="o">=</span> <span class="n">qdf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="n">dev_info</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">dicontent</span><span class="p">)</span>

                <span class="n">verified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_cache_verify_device_info</span><span class="p">(</span><span class="n">dev_info</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verified</span><span class="p">:</span>
                    <span class="n">found_devices</span><span class="p">[</span><span class="n">qdev_usn</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_info</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">qdev_filename</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">found_devices</span>

    <span class="k">def</span> <span class="nf">_device_cache_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">found_device</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPNP_CACHE_DIR</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPNP_CACHE_DIR</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">fdev_usn</span> <span class="ow">in</span> <span class="n">found_device</span><span class="p">:</span>
            <span class="n">fdev_info</span> <span class="o">=</span> <span class="n">found_device</span><span class="p">[</span><span class="n">fdev_usn</span><span class="p">]</span>
            <span class="n">fdev_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UPNP_CACHE_DIR</span><span class="p">,</span> <span class="n">fdev_usn</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fdev_filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">dcf</span><span class="p">:</span>
                <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fdev_info</span><span class="p">,</span> <span class="n">dcf</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_device_cache_verify_device_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">device_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">MSearchKeys</span><span class="o">.</span><span class="n">USN_DEV</span> <span class="ow">in</span> <span class="n">device_info</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">valid</span>

    <span class="k">def</span> <span class="nf">_device_msearch_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">interface_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">response_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">retry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>

        <span class="n">found_devices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">matching_devices</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">qdevice_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">query_devices</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ridx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">retry</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ridx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;MSEARCH: Not all devices found, retrying (count=</span><span class="si">%d</span><span class="s2">)...&quot;</span> <span class="o">%</span> <span class="n">ridx</span><span class="p">)</span>
            <span class="n">iter_found_devices</span><span class="p">,</span> <span class="n">iter_matching_devices</span> <span class="o">=</span> <span class="n">msearch_scan</span><span class="p">(</span><span class="n">query_devices</span><span class="p">,</span>
                <span class="n">interface_list</span><span class="o">=</span><span class="n">interface_list</span><span class="p">,</span> <span class="n">response_timeout</span><span class="o">=</span><span class="n">response_timeout</span><span class="p">)</span>
            <span class="n">found_devices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iter_found_devices</span><span class="p">)</span>
            <span class="n">matching_devices</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iter_matching_devices</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_devices</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">qdevice_count</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">found_devices</span><span class="p">,</span> <span class="n">matching_devices</span>

    <span class="k">def</span> <span class="nf">_device_scan_with_arp_and_mquery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">interface_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">response_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="n">retry</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">):</span>

        <span class="n">found_devices</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">matching_devices</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">missing_devices_checklist</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">query_devices</span><span class="p">]</span>

        <span class="c1"># If we are missing some devices, lets try to wake them up and also attempt to find</span>
        <span class="c1"># them in the ARP table.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;* Forcing the ARP table to refresh.&quot;</span><span class="p">)</span>
        <span class="n">refresh_arp_table</span><span class="p">()</span>

        <span class="c1"># Try to use the ARP table to hint about the device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;* Looking for device and interface hints in the APR table.&quot;</span><span class="p">)</span>
        <span class="n">requery_devices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">arp_table</span> <span class="o">=</span> <span class="n">get_arp_table</span><span class="p">(</span><span class="n">normalize_hwaddr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dmac</span><span class="p">,</span> <span class="n">dinfo</span> <span class="ow">in</span> <span class="n">arp_table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">usn_match</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">usn</span> <span class="ow">in</span> <span class="n">missing_devices_checklist</span><span class="p">:</span>
                <span class="n">usn_norm</span> <span class="o">=</span> <span class="n">usn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">usn_norm</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">dmac</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">usn_match</span> <span class="o">=</span> <span class="n">usn</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">usn_match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">missing_devices_checklist</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">usn_match</span><span class="p">)</span>
                <span class="n">requery_devices</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">usn_match</span><span class="p">,</span> <span class="n">dinfo</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;* Trying to requery the missing devices.&quot;</span><span class="p">)</span>
        <span class="c1"># As a last resort, rescan for the missing devices directly via unicast.</span>
        <span class="k">for</span> <span class="n">expusn</span><span class="p">,</span> <span class="n">dev_hint</span> <span class="ow">in</span> <span class="n">requery_devices</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wakeup_device</span><span class="p">(</span><span class="n">expusn</span><span class="p">,</span> <span class="n">dev_hint</span><span class="p">)</span>

                <span class="n">requery_ip</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">dev_hint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">requery_ip</span><span class="o">=</span><span class="n">dev_hint</span><span class="p">[</span><span class="s2">&quot;ip&quot;</span><span class="p">]</span>

                <span class="n">device_info</span> <span class="o">=</span> <span class="n">mquery_host</span><span class="p">(</span><span class="n">expusn</span><span class="p">,</span> <span class="n">requery_ip</span><span class="p">,</span> <span class="n">response_timeout</span><span class="o">=</span><span class="n">response_timeout</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">device_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">found_devices</span><span class="p">[</span><span class="n">expusn</span><span class="p">]</span> <span class="o">=</span> <span class="n">device_info</span>
                    <span class="n">query_devices</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">expusn</span><span class="p">)</span>

            <span class="k">except</span> <span class="n">AKitTimeoutError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">found_devices</span><span class="p">,</span> <span class="n">matching_devices</span>

    <span class="k">def</span> <span class="nf">_log_scan_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">found_devices</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">matching_devices</span><span class="p">:</span><span class="nb">dict</span> <span class="p">,</span> <span class="n">missing_devices</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Logs the results of the device scan.</span>

<span class="sd">            :param found_devices: A list of found devices.</span>
<span class="sd">            :param matching_devices: A list of devices matching the expected devices listed in the upnp_hint_list.</span>
<span class="sd">            :param missing_devices: A list of USN(s) for devices that were not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">devmsg_lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;FOUND DEVICES:&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">dkey</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">found_devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dkey</span><span class="p">)</span>
        <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MATCHING DEVICES:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dkey</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">matching_devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dkey</span><span class="p">)</span>
        <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_devices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;MISSING DEVICES:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dkey</span> <span class="ow">in</span> <span class="n">missing_devices</span><span class="p">:</span>
                <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">dkey</span><span class="p">)</span>
            <span class="n">devmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">devmsg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">devmsg_lines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">devmsg</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_normalize_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Normalizes a name by removing non-alphanumeric characters.</span>

<span class="sd">            :param name: A name to normalize.</span>

<span class="sd">            :returns: The normalized name with all the non-alphanumeric characters removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=no-self-use</span>

        <span class="n">normal_chars</span> <span class="o">=</span> <span class="p">[</span> <span class="n">nc</span> <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="n">name</span> <span class="k">if</span> <span class="nb">str</span><span class="o">.</span><span class="n">isalnum</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">normal_name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">normal_chars</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">normal_name</span>

    <span class="k">def</span> <span class="nf">_process_device_alive_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">,</span> <span class="n">usn_device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Processes a device alive notification when given the USN and dictionary of header keys and values.</span>

<span class="sd">            :param usn: The USN of the device which the notification is from.</span>
<span class="sd">            :param request_info: The headers from the notification request.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ip_addr</span> <span class="o">=</span> <span class="n">request_info</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">IP</span><span class="p">]</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">request_info</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">LOCATION</span><span class="p">]</span>

        <span class="c1"># Get a reference to the landscape</span>
        <span class="n">lscape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">landscape</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_activate_root_device</span><span class="p">(</span><span class="n">lscape</span><span class="p">,</span> <span class="n">usn_device</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">request_info</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_process_device_byebye_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">,</span> <span class="n">usn_device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Processes a device byebye notification when given the USN and dictionary of header keys and values.</span>

<span class="sd">            :param usn: The USN of the device which the notification is from.</span>
<span class="sd">            :param request_info: The headers from the notification request.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ip_addr</span> <span class="o">=</span> <span class="n">request_info</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">IP</span><span class="p">]</span>

        <span class="n">location</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
        <span class="k">if</span> <span class="n">MSearchKeys</span><span class="o">.</span><span class="n">LOCATION</span> <span class="ow">in</span> <span class="n">request_info</span><span class="p">:</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">request_info</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">LOCATION</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Blah&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Blah&quot;</span><span class="p">)</span>

        <span class="c1"># Get a reference to the landscape</span>
        <span class="n">lscape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">landscape</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_deactivate_root_device</span><span class="p">(</span><span class="n">lscape</span><span class="p">,</span> <span class="n">usn_device</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">request_info</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_process_service_alive_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">,</span> <span class="n">usn_device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">usn_class</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_process_service_byebye_notification</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">,</span> <span class="n">usn_device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">usn_class</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_info</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_process_subscription_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ifname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">claddr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">asock</span><span class="p">:</span> <span class="n">socket</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Processes a callback request on the specified interface and address request.</span>

<span class="sd">            :param ifname: The name of the ifname the request came from.</span>
<span class="sd">            :param claddr: The address of the client that made the callback.</span>
<span class="sd">            :param request: The content of the callback request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=unused-argument</span>

        <span class="n">cbbuffer</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>

        <span class="n">req_headers</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">headers_length</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">content_length</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">message_length</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">read_so_far</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">remaining_length</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Read To Header</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="ow">and</span> <span class="n">remaining_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Process the requests</span>
                <span class="n">nxtbuff</span> <span class="o">=</span> <span class="n">asock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">remaining_length</span><span class="p">)</span>
                <span class="n">read_so_far</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nxtbuff</span><span class="p">)</span>

                <span class="c1"># If we didn&#39;t get anything from recv, it means we hit the end of</span>
                <span class="c1"># the pipe.  We can exit the read loop.</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nxtbuff</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>

                <span class="n">cbbuffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">nxtbuff</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">req_headers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">current_content</span> <span class="o">=</span> <span class="n">cbbuffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
                    <span class="n">header_end</span> <span class="o">=</span> <span class="n">current_content</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">HTTP1_1_END_OF_HEADER</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">header_end</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">header_content</span> <span class="o">=</span> <span class="n">current_content</span><span class="p">[:</span><span class="n">header_end</span><span class="p">]</span>
                        <span class="n">headers_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">header_content</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">HTTP1_1_END_OF_HEADER</span><span class="p">)</span>
                        <span class="n">req_line</span><span class="p">,</span> <span class="n">req_headers</span> <span class="o">=</span> <span class="n">http_parse_header</span><span class="p">(</span><span class="n">header_content</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s2">&quot;CONTENT-LENGTH&quot;</span> <span class="ow">in</span> <span class="n">req_headers</span><span class="p">:</span>
                            <span class="n">content_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">req_headers</span><span class="p">[</span><span class="s2">&quot;CONTENT-LENGTH&quot;</span><span class="p">])</span>
                            <span class="n">message_length</span> <span class="o">=</span> <span class="n">headers_length</span> <span class="o">+</span> <span class="n">content_length</span>
                
                <span class="k">if</span> <span class="n">message_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">remaining_length</span> <span class="o">=</span> <span class="n">message_length</span> <span class="o">-</span> <span class="n">read_so_far</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">asock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">UPNP_SUBSCRIPTION_NOTIFY_RESPONSE_OK</span><span class="p">)</span>
            <span class="n">asock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">cbbuffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>

        <span class="n">cbbuffer</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">cbbuffer</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">req_body</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="n">headers_length</span><span class="p">:]</span>

        <span class="n">sid</span> <span class="o">=</span> <span class="n">req_headers</span><span class="p">[</span><span class="s2">&quot;SID&quot;</span><span class="p">]</span>

        <span class="n">device</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#lookup the device that needs to handle this subscription</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_subscription_id_to_device</span><span class="p">:</span>
                <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_subscription_id_to_device</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">device</span><span class="o">.</span><span class="n">process_subscription_callback</span><span class="p">(</span><span class="n">claddr</span><span class="p">,</span> <span class="n">sid</span><span class="p">,</span> <span class="n">req_headers</span><span class="p">,</span> <span class="n">req_body</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errmsg</span> <span class="o">=</span> <span class="s2">&quot;Received subscription notification for unknown sid.  claddr=</span><span class="si">{}</span><span class="s2"> sid=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">claddr</span><span class="p">,</span> <span class="n">sid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_process_request_for_msearch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Process an msearch request from the given address.</span>

<span class="sd">            :param addr: The address of machine making the msearch request.</span>
<span class="sd">            :param request: The request content of the msearch request to process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#reqinfo = msearch_parse_request(request)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RESPONDING TO MSEARCH&quot;</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_process_request_for_notify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Process a notify request.</span>

<span class="sd">            :param addr: The address of machine making the notify request.</span>
<span class="sd">            :param request: The request content of the notify request to process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">req_headers</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">notify_parse_request</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="n">usn</span> <span class="o">=</span> <span class="n">req_headers</span><span class="p">[</span><span class="s2">&quot;USN&quot;</span><span class="p">]</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">req_headers</span><span class="p">[</span><span class="s2">&quot;HOST&quot;</span><span class="p">]</span>
        <span class="n">subtype</span> <span class="o">=</span> <span class="n">req_headers</span><span class="p">[</span><span class="s2">&quot;NTS&quot;</span><span class="p">]</span>

        <span class="n">ip_addr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">addr</span>
        <span class="k">if</span> <span class="n">MSearchKeys</span><span class="o">.</span><span class="n">IP</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">req_headers</span><span class="p">:</span>
            <span class="n">req_headers</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">IP</span><span class="p">]</span> <span class="o">=</span> <span class="n">ip_addr</span>

        <span class="k">if</span> <span class="n">usn</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">usn_device</span><span class="p">,</span> <span class="n">usn_class</span> <span class="o">=</span> <span class="n">usn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;::&quot;</span><span class="p">)</span>
            <span class="n">usn_device</span> <span class="o">=</span> <span class="n">usn_device</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&quot;uuid:&quot;</span><span class="p">)</span>

            <span class="n">ifname</span> <span class="o">=</span> <span class="n">get_interface_for_ip</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">)</span>

            <span class="n">req_headers</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">USN_DEV</span><span class="p">]</span> <span class="o">=</span> <span class="n">usn_device</span>
            <span class="n">req_headers</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">USN_CLS</span><span class="p">]</span> <span class="o">=</span> <span class="n">usn_class</span>
            <span class="n">req_headers</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">ROUTES</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="n">MSearchRouteKeys</span><span class="o">.</span><span class="n">IFNAME</span><span class="p">:</span> <span class="n">ifname</span><span class="p">,</span>
                    <span class="n">MSearchRouteKeys</span><span class="o">.</span><span class="n">IP</span><span class="p">:</span> <span class="n">ip_addr</span>
                <span class="p">}</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="n">subtype</span> <span class="o">==</span> <span class="s2">&quot;ssdp:alive&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">usn_class</span> <span class="o">==</span> <span class="s2">&quot;upnp:rootdevice&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process_device_alive_notification</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">usn_device</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">req_headers</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process_service_alive_notification</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">usn_device</span><span class="p">,</span> <span class="n">usn_class</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">req_headers</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">subtype</span> <span class="o">==</span> <span class="s2">&quot;ssdp:byebye&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">usn_class</span> <span class="o">==</span> <span class="s2">&quot;upnp:rootdevice&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process_device_byebye_notification</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">usn_device</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">req_headers</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_process_service_byebye_notification</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">usn_device</span><span class="p">,</span> <span class="n">usn_class</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">req_headers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;UNKNOWNK NOTIFY - USN: </span><span class="si">%s</span><span class="s2"> HOST: </span><span class="si">%s</span><span class="s2"> SUBTYPE: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">usn</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">subtype</span><span class="p">))</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_start_all_threads</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Starts up all the thread the UPNP coordinator uses for monitoring, callback notification servicing and</span>
<span class="sd">            the worker threads used for processing work packges from notifications and callbacks.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ifacelist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">wdev</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">watch_devices</span><span class="p">:</span>
            <span class="n">primary_route</span> <span class="o">=</span> <span class="n">wdev</span><span class="o">.</span><span class="n">upnp</span><span class="o">.</span><span class="n">routes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ifname</span> <span class="o">=</span> <span class="n">primary_route</span><span class="p">[</span><span class="n">MSearchRouteKeys</span><span class="o">.</span><span class="n">IFNAME</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ifname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ifacelist</span><span class="p">:</span>
                <span class="n">ifacelist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ifname</span><span class="p">)</span>
        <span class="n">ifacecount</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ifacelist</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sgate</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_count</span> <span class="o">+</span> <span class="n">ifacecount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1"># Spin-up the worker threads first so they will be ready to handle work packets</span>
            <span class="k">for</span> <span class="n">wkrid</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_count</span><span class="p">):</span>
                <span class="n">sgate</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">wthread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;UpnpCoordinator - Worker(</span><span class="si">%d</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">wkrid</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_entry_worker</span><span class="p">,</span>
                                                   <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sgate</span><span class="p">,))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_worker_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wthread</span><span class="p">)</span>

                <span class="c1"># Release the coordinator lock while starting up the thread so we are not holding it</span>
                <span class="c1"># so the new thread can get access to register itself with internal UpnpCoordinator state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wthread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">sgate</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

            <span class="c1"># Spin-up the Monitor thread so it can monitor notification traffic</span>
            <span class="n">sgate</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;UpnpCoordinator - Monitor&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_entry_monitor</span><span class="p">,</span>
                                                   <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sgate</span><span class="p">,))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">sgate</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="c1"># Spin-up a Callback thread for each interface</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_iface_callback_addr_lookup</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">ifaceidx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ifacecount</span><span class="p">):</span>
                <span class="n">ifname</span> <span class="o">=</span> <span class="n">ifacelist</span><span class="p">[</span><span class="n">ifaceidx</span><span class="p">]</span>
                <span class="n">sgate</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">cbthread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;UpnpCoordinator - Callback(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_entry_callback</span><span class="p">,</span>
                                                    <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sgate</span><span class="p">,</span> <span class="n">ifname</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_callback_threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cbthread</span><span class="p">)</span>

                <span class="c1"># Release the coordinator lock while starting up the thread so we are not holding it</span>
                <span class="c1"># so the new thread can get access to register itself with internal UpnpCoordinator state</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cbthread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                    <span class="n">sgate</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_count</span> <span class="o">+</span> <span class="n">ifacecount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_thread_entry_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sgate</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span> <span class="n">ifname</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The entry point for callback processing threads.</span>

<span class="sd">            :param sgate: The startup gate that is used to indicate to the thread spinning up the coordinator</span>
<span class="sd">                          that the callback thread has started.</span>
<span class="sd">            :param ifname: The interface name of interface this thread is assigned to process callbacks for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">service_addr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>

            <span class="c1"># Bind to port zero so we can get an ephimeral port address</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">service_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">get_ipv4_address</span><span class="p">(</span><span class="n">ifname</span><span class="p">)</span>

            <span class="n">iface_callback_addr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_iface_callback_addr_lookup</span><span class="p">[</span><span class="n">ifname</span><span class="p">]</span> <span class="o">=</span> <span class="n">iface_callback_addr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cl_callback_interface_sockets</span><span class="p">[</span><span class="n">ifname</span><span class="p">]</span> <span class="o">=</span> <span class="n">sock</span>

            <span class="c1"># Set the start gate to allow the thread spinning us up to continue</span>
            <span class="n">sgate</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="n">sock</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
                <span class="n">asock</span><span class="p">,</span> <span class="n">claddr</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>

                <span class="c1"># Queue the callback workpacket for dispatching by a worker thread</span>
                <span class="n">wkpacket</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_subscription_callback</span><span class="p">,</span> <span class="p">(</span><span class="n">ifname</span><span class="p">,</span> <span class="n">claddr</span><span class="p">,</span> <span class="n">asock</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_queue_work</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wkpacket</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_queue_available</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_thread_entry_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sgate</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The entry point for monitor thread.  The monitor thread sets up monitoring on all interfaces.</span>

<span class="sd">            :param sgate: The startup gate that is used to indicate to the thread spinning up the coordinator</span>
<span class="sd">                          that the monitor thread has started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="n">multicast_address</span> <span class="o">=</span> <span class="n">UpnpProtocol</span><span class="o">.</span><span class="n">MULTICAST_ADDRESS</span>
        <span class="n">multicast_port</span> <span class="o">=</span> <span class="n">UpnpProtocol</span><span class="o">.</span><span class="n">PORT</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set the start gate to allow the thread spinning us up to continue</span>
            <span class="n">sgate</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_UDP</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Make sure other Automation processes can also bind to the UPNP address and port</span>
                <span class="c1"># so they can also get responses.</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEPORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Set us up to be a member of the group, this allows us to receive all the packets</span>
                <span class="c1"># that are sent to the group</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IP_ADD_MEMBERSHIP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="n">multicast_address</span><span class="p">)</span> <span class="o">+</span> <span class="n">socket</span><span class="o">.</span><span class="n">inet_aton</span><span class="p">(</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">))</span>

                <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">multicast_address</span><span class="p">,</span> <span class="n">multicast_port</span><span class="p">))</span>

                <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
                    <span class="n">request</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;M-SEARCH&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_control_point</span><span class="p">:</span>
                            <span class="n">wkpacket</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_request_for_msearch</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_queue_work</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wkpacket</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_queue_available</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                            <span class="k">finally</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;NOTIFY&quot;</span><span class="p">):</span>
                        <span class="n">wkpacket</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_request_for_notify</span><span class="p">,</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">request</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_queue_work</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wkpacket</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_queue_available</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                        <span class="k">finally</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">dbgmsg</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;UNKNOWN REQUEST TYPE:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">request</span>
                        <span class="n">dbgmsg</span> <span class="o">=</span> <span class="n">dbgmsg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">dbgmsg</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_thread_entry_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sgate</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            The entry point for worker threads.  Worker threads process work packets queued up by other threads.</span>

<span class="sd">            :param sgate: The startup gate that is used to indicate to the thread spinning up the coordinator</span>
<span class="sd">                          that this worker thread has started.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Set the start gate to allow the thread spinning us up to continue</span>
            <span class="n">sgate</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_queue_available</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wkfunc</span><span class="p">,</span> <span class="n">wkargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue_work</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">wkfunc</span><span class="p">(</span><span class="o">*</span><span class="n">wkargs</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span> <span class="c1"># pylint: disable=bare-except</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;UpnpCoordinator: Worker exception.&quot;</span><span class="p">)</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_queue_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_gate</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_activate_root_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lscape</span><span class="p">:</span> <span class="s2">&quot;Landscape&quot;</span><span class="p">,</span> <span class="n">usn_device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">deviceinfo</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_device_by_usn</span><span class="p">(</span><span class="n">usn_device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Mark the device active</span>
            <span class="n">dev</span><span class="o">.</span><span class="n">upnp</span><span class="o">.</span><span class="n">mark_alive</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_unknown_devices</span><span class="p">:</span>
            <span class="n">config_lookup</span> <span class="o">=</span> <span class="n">lscape</span><span class="o">.</span><span class="n">_internal_get_upnp_device_config_lookup_table</span><span class="p">()</span> <span class="c1"># pylint: disable=protected-access</span>

            <span class="n">usn_dev</span> <span class="o">=</span> <span class="n">deviceinfo</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">USN_DEV</span><span class="p">]</span>

            <span class="n">marked_as_skip</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">usn_dev</span> <span class="ow">in</span> <span class="n">config_lookup</span><span class="p">:</span>
                <span class="n">configinfo</span> <span class="o">=</span> <span class="n">config_lookup</span><span class="p">[</span><span class="n">usn_dev</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;skip&quot;</span> <span class="ow">in</span> <span class="n">configinfo</span> <span class="ow">and</span> <span class="n">configinfo</span><span class="p">[</span><span class="s2">&quot;skip&quot;</span><span class="p">]:</span>
                    <span class="n">marked_as_skip</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">marked_as_skip</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_root_device</span><span class="p">(</span><span class="n">lscape</span><span class="p">,</span> <span class="n">config_lookup</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">deviceinfo</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_deactivate_root_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lscape</span><span class="p">:</span> <span class="s2">&quot;Landscape&quot;</span><span class="p">,</span> <span class="n">usn_device</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">deviceinfo</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_device_by_usn</span><span class="p">(</span><span class="n">usn_device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Mark the device active</span>
            <span class="n">dev</span><span class="o">.</span><span class="n">upnp</span><span class="o">.</span><span class="n">mark_byebye</span><span class="p">()</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_update_root_device</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lscape</span><span class="p">,</span> <span class="n">config_lookup</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ip_addr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">location</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">deviceinfo</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Updates a UPNP root device.</span>

<span class="sd">            :param lscape: The landscape singleton instance.</span>
<span class="sd">            :param config_lookup: A configuration lookup table that can be used to lookup configuration information for upnp devices.</span>
<span class="sd">            :param ip_addr: The IP address of the device to update.</span>
<span class="sd">            :param location: The location URL associated with the device.</span>
<span class="sd">            :param deviceinfo: The device information from the msearch response headers.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">MSearchKeys</span><span class="o">.</span><span class="n">USN_DEV</span> <span class="ow">in</span> <span class="n">deviceinfo</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">usn_dev</span> <span class="o">=</span> <span class="n">deviceinfo</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">USN_DEV</span><span class="p">]</span>
                <span class="n">usn_cls</span> <span class="o">=</span> <span class="n">deviceinfo</span><span class="p">[</span><span class="n">MSearchKeys</span><span class="o">.</span><span class="n">USN_CLS</span><span class="p">]</span>

                <span class="n">configinfo</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">usn_dev</span> <span class="ow">in</span> <span class="n">config_lookup</span><span class="p">:</span>
                    <span class="n">configinfo</span> <span class="o">=</span> <span class="n">config_lookup</span><span class="p">[</span><span class="n">usn_dev</span><span class="p">]</span>

                <span class="n">docTree</span> <span class="o">=</span> <span class="n">device_description_load</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># {urn:schemas-upnp-org:device-1-0}root</span>
                    <span class="n">namespaces</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;&quot;</span><span class="p">:</span> <span class="n">UPNP_DEVICE1_NAMESPACE</span><span class="p">}</span>

                    <span class="n">deviceDescParts</span> <span class="o">=</span> <span class="n">device_description_find_components</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">docTree</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
                    <span class="n">devNode</span><span class="p">,</span> <span class="n">urlBase</span><span class="p">,</span> <span class="n">manufacturer</span><span class="p">,</span> <span class="n">modelName</span><span class="p">,</span> <span class="n">modelNumber</span><span class="p">,</span> <span class="n">modelDescription</span> <span class="o">=</span> <span class="n">deviceDescParts</span>

                    <span class="n">dev_extension</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Acquire the lock before we decide if the location exists in the children table</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">location</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># Unlock while we do some expensive stuff, we have already decided to</span>
                                <span class="c1"># create the device</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

                                <span class="k">try</span><span class="p">:</span>
                                    <span class="c1"># We create the device</span>
                                    <span class="n">dev_extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_root_device</span><span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">modelNumber</span><span class="p">,</span> <span class="n">modelDescription</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">errmsg</span> <span class="o">=</span> <span class="s2">&quot;ERROR: Unable to create device mfg=</span><span class="si">%s</span><span class="s2"> model=</span><span class="si">%s</span><span class="s2"> desc=</span><span class="si">%s</span><span class="se">\n</span><span class="s2">TRACEBACK:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">manufacturer</span><span class="p">,</span> <span class="n">modelNumber</span><span class="p">,</span> <span class="n">modelDescription</span><span class="p">)</span>
                                    <span class="n">errmsg</span> <span class="o">+=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>
                                    <span class="k">raise</span>

                                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dev_extension</span><span class="p">,</span> <span class="n">UpnpRootDevice</span><span class="p">):</span>
                                    <span class="n">dev_extension</span><span class="o">.</span><span class="n">record_description</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">urlBase</span><span class="p">,</span> <span class="n">manufacturer</span><span class="p">,</span> <span class="n">modelName</span><span class="p">,</span> <span class="n">docTree</span><span class="p">,</span> <span class="n">devNode</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">,</span> <span class="n">upnp_recording</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_upnp_recording</span><span class="p">)</span>

                                <span class="n">coord_ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

                                <span class="n">basedevice</span> <span class="o">=</span> <span class="n">lscape</span><span class="o">.</span><span class="n">_internal_lookup_device_by_keyid</span><span class="p">(</span><span class="n">usn_dev</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">basedevice</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allow_unknown_devices</span><span class="p">:</span>
                                    <span class="n">dev_type</span> <span class="o">=</span> <span class="s2">&quot;network/upnp&quot;</span>
                                    <span class="n">dev_config_info</span> <span class="o">=</span> <span class="p">{</span>
                                        <span class="s2">&quot;deviceType&quot;</span><span class="p">:</span> <span class="n">dev_type</span><span class="p">,</span>
                                        <span class="s2">&quot;deviceClass&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
                                        <span class="s2">&quot;upnp&quot;</span><span class="p">:</span> <span class="p">{</span>
                                            <span class="s2">&quot;USN&quot;</span><span class="p">:</span> <span class="n">usn_dev</span><span class="p">,</span>
                                            <span class="s2">&quot;modelName&quot;</span><span class="p">:</span> <span class="n">modelName</span><span class="p">,</span>
                                            <span class="s2">&quot;modelNumber&quot;</span><span class="p">:</span> <span class="n">modelNumber</span>
                                        <span class="p">},</span>
                                        <span class="s2">&quot;USN_DEV&quot;</span><span class="p">:</span> <span class="n">usn_dev</span><span class="p">,</span>
                                        <span class="s2">&quot;USN_CLS&quot;</span><span class="p">:</span> <span class="n">usn_cls</span>
                                    <span class="p">}</span>
                                    <span class="n">basedevice</span> <span class="o">=</span> <span class="n">lscape</span><span class="o">.</span><span class="n">_create_landscape_device</span><span class="p">(</span><span class="n">usn_dev</span><span class="p">,</span> <span class="n">dev_type</span><span class="p">,</span> <span class="n">dev_config_info</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">basedevice</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">basedevice</span> <span class="o">=</span> <span class="n">lscape</span><span class="o">.</span><span class="n">_enhance_landscape_device</span><span class="p">(</span><span class="n">basedevice</span><span class="p">,</span> <span class="n">dev_extension</span><span class="p">)</span>

                                    <span class="n">basedevice_ref</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">basedevice</span><span class="p">)</span>

                                    <span class="n">dev_extension</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">coord_ref</span><span class="p">,</span> <span class="n">basedevice_ref</span><span class="p">,</span> <span class="n">usn_dev</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">configinfo</span><span class="p">,</span> <span class="n">deviceinfo</span><span class="p">)</span>

                                    <span class="c1"># Refresh the description</span>
                                    <span class="n">dev_extension</span><span class="o">.</span><span class="n">refresh_description</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">,</span> <span class="n">docTree</span><span class="o">.</span><span class="n">getroot</span><span class="p">(),</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
                                    <span class="n">dev_extension</span><span class="o">.</span><span class="n">mark_alive</span><span class="p">()</span>

                                    <span class="n">basedevice</span><span class="o">.</span><span class="n">attach_extension</span><span class="p">(</span><span class="s2">&quot;upnp&quot;</span><span class="p">,</span> <span class="n">dev_extension</span><span class="p">)</span>

                                    <span class="n">basedevice</span><span class="o">.</span><span class="n">initialize_features</span><span class="p">()</span>
                                    <span class="n">basedevice</span><span class="o">.</span><span class="n">update_match_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_match_table</span><span class="p">)</span>

                                    <span class="n">lscape</span><span class="o">.</span><span class="n">_internal_activate_device</span><span class="p">(</span><span class="n">usn_dev</span><span class="p">)</span>
                            <span class="k">finally</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

                            <span class="c1"># If the device is still not in the table, add it</span>
                            <span class="k">if</span> <span class="n">location</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="p">[</span><span class="n">location</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_extension</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">dev_extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cl_children</span><span class="p">[</span><span class="n">location</span><span class="p">]</span>
                            <span class="c1"># Refresh the description</span>
                            <span class="n">dev_extension</span><span class="o">.</span><span class="n">refresh_description</span><span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_factory</span><span class="p">,</span> <span class="n">docTree</span><span class="o">.</span><span class="n">getroot</span><span class="p">(),</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces</span><span class="p">)</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_coord_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>  <span class="c1"># pylint: disable=bare-except</span>
                    <span class="n">exmsg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">errmsg_lines</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="s2">&quot;ERROR: Unable to parse description for. IP: </span><span class="si">%s</span><span class="s2"> LOCATION: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">location</span><span class="p">),</span>
                        <span class="n">exmsg</span>
                    <span class="p">]</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">deviceinfo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">errmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

                    <span class="n">errmsg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errmsg_lines</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

            <span class="k">except</span><span class="p">:</span>  <span class="c1"># pylint: disable=bare-except</span>
                <span class="n">exmsg</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">errmsg_lines</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="s2">&quot;ERROR: Unable to parse description for. IP: </span><span class="si">%s</span><span class="s2"> LOCATION: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ip_addr</span><span class="p">,</span> <span class="n">location</span><span class="p">),</span>
                    <span class="n">exmsg</span>
                <span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">deviceinfo</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">errmsg_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>

                <span class="n">errmsg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">linesep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errmsg_lines</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">errmsg</span><span class="p">)</span>

        <span class="k">return</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Myron W. Walker.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>